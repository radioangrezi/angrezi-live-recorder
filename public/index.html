<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="Angrezi Controller">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <title>Radio Angrezi Controller</title>
        <link href="normalize.css" rel="stylesheet"/>
        <link href="controller.css" rel="stylesheet"/>
        <script type="text/javascript">

        window.onload = function () {

            window.API_HOST = 'http://localhost:5000' // no tailing slash /

            window.icecast_stream = {

                status_elem: document.querySelector("#icecast-stream p.status"),

                update_icecast_stream_status: function(){
                    var module_parent = this
                    fetch(window.API_HOST + '/airtime/on-air-light/')
                    .then((res) => {
                        return res.json().then(function (data) {
                            status_elem = icecast_stream.status_elem;
                            //icecast_stream.status_elem.innerHTML = data.text
                            if(data.on_air_light == true){
                                status_elem.innerHTML = "On Air"
                                status_elem.style = "background: red;";
                            }else {
                                status_elem.innerHTML = "Off Air"
                                status_elem.style = "background: gray";
                            }
                        });
                    })
                    .catch((error) => live_recorder.log(error))
                },

                init: function() {
                    var interval = window.setInterval(this.update_icecast_stream_status, 1000);
                    return this;
                }

            }.init()

            window.live_recorder = {

                status_elem: document.querySelector("#live-recorder p.status"),
                button_elem: document.querySelector("#live-recorder .button"),
                output_elem: document.querySelector("#live-recorder textarea.output"),

                //master_source_status_elem: status_elem: document.querySelector("#master-source p.status"),

                log: function(text){
                    console.log(text)
                    var d = new Date()
                    var n = d.toLocaleTimeString()
                    live_recorder.output_elem.value += n + ": " + text + "\n"
                    // scroll to bottom
                    live_recorder.output_elem.scrollTop = live_recorder.output_elem.scrollHeight;
                },

                update_status: function(){
                    var module_parent = this
                    fetch(window.API_HOST + '/recorder/')
                    .then((res) => {
                        return res.json().then(function (data) {
                            console.log(data)
                            live_recorder.status_elem.innerHTML = data.text
                            if(data.status < 0){
                                live_recorder.status_elem.style = "background: yellow; color: black;";
                            }else if(data.status == 0){
                                live_recorder.status_elem.style = "background: gray";
                            }else if(data.status == 1){
                                live_recorder.status_elem.style = "background: red";
                            } if(data.status > 1){
                                live_recorder.status_elem.style = "background: blue";
                            }
                        });
                    })
                    .catch((error) => live_recorder.log(error))
                },

                
                reset_recordning: function(){

                    fetch('/proxy/live-recorder/reset')
                    .then((res) => {
                        return res.text().then(function (text) {
                            live_recorder.status_elem.style = "background: #66FF00";
                            live_recorder.log(text)
                        });
                    })
                    .catch((error) => live_recorder.log(error))

                },

                init: function() {
                    //var recorder_interval = window.setInterval(this.update_status, 1000);
                    return this;
                }

            }.init();

        };

        </script>
    </head>
    <body>
        <header>
            <h1>Radio Angrezi <span>Controller</span></h1>
        </header>
        <main>
            <section id="icecast-stream" class="box">
                <p class="status module-row">IDLE</p>
            </section>
            <section id="master-source" class="box">
                <p class="status module-row">IDLE</p>
            </section>
            <section id="live-recorder" class="box">
                <h2 class="module-label label">Live Recorder</h2>
                <p class="status module-row">IDLE</p>
                <button class="button module-row doubleclick" ondblclick="live_recorder.reset_recordning()">
                    <small>( double click )</small>
                    <p>Start New Recording</p>
                    <small class="warning">Attention! Can't be undone.</small>
                </button>
                <h3 class="label">Output</h3>
                <textarea readonly="readonly" class="output textarea module-row"></textarea>
            </section>
        </main>
    </body>
</html>